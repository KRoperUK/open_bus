name: Deploy

on:
    push:
        branches: [ "main" ]
    pull_request:
        branches: [ "main" ]
    workflow_dispatch:

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v3

            - name: Install Pip packages
              run: |
                    python3 -m pip install --upgrade pip
                    pip install -r requirements.txt
            
            - name: Run Python script
              run: |
                    echo "GOV_API_KEY=${{ secrets.GOV_API_KEY }}" >> .env
                    python3 gov.py
                    rm .env

            - name: Move to site
              run: cd site

            - name: Setup Ruby
              uses: ruby/setup-ruby@8575951200e472d5f2d95c625da0c7bec8217c42 # v1.161.0
              with:
                ruby-version: '3.1' # Not needed with a .ruby-version file
                bundler-cache: true # runs 'bundle install' and caches installed gems automatically
                cache-version: 0 # Increment this number if you need to re-download cached gems

            - name: Setup Pages
              uses: actions/configure-pages@v3

            - name: Build with Jekyll
              # Outputs to the './_site' directory by default
              run: |
                cd site
                bundle install
                bundle exec jekyll build --baseurl "${{ steps.pages.outputs.base_path }}"
              env:
                JEKYLL_ENV: production

            - name: Upload artifact
              uses: actions/upload-pages-artifact@v3
    
    # Deploy job
    deploy:
        # Add a dependency to the build job
        needs: build
    
        # Grant GITHUB_TOKEN the permissions required to make a Pages deployment
        permissions:
            pages: write      # to deploy to Pages
            id-token: write   # to verify the deployment originates from an appropriate source
    
        # Deploy to the github-pages environment
        environment:
            name: github-pages
            url: ${{ steps.deployment.outputs.page_url }}
    
        # Specify runner + deployment step
        runs-on: ubuntu-latest
        steps:
            - name: Deploy to GitHub Pages
              id: deployment
              uses: actions/deploy-pages@v4 # or specific "vX.X.X" version tag for this action


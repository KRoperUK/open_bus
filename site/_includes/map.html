<div id="map"></div>

<script>
    var coordinates = {{ site.data.bus_objects | jsonify }};
    var map = L.map('map').setView([52.45033122641582, -1.930996616069787], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',
        maxZoom: 18,
    }).addTo(map);

    map.locate({setView: true, maxZoom: 16});

    function onLocationFound(e) {
        var radius = e.accuracy / 2;
        L.circle(e.latlng, radius).addTo(map);
    }

    map.on('locationfound', onLocationFound);

    function onLocationError(e) {
        console.log(e.message);
    }

    map.on('locationerror', onLocationError);

    
    

    // Add markers for each item in coordinates
    var services = []; // Initialize an array to store string values for all operators

    for (var key in coordinates) {
        for (var i = 0; i < coordinates[key].length; i++) {
            var date_bus = new Date(coordinates[key][i]['recordedAtTime']);
            var date_now = new Date();

            const TIME_DIFF = date_now - date_bus

            if (TIME_DIFF > 5*60*1000) {
                continue;
            }

            const POPUP_STRING = `
                Operator: ${coordinates[key][i]['operatorRef']}
                <br>
                Service: ${coordinates[key][i]['lineRef']}
                <br>
                Vehicle: ${coordinates[key][i]['vehicleRef']}
                <br>
                Origin: ${coordinates[key][i]['originName'].replaceAll('_', ' ')}
                <br>
                Destination: ${coordinates[key][i]['destinationName'].replaceAll('_', ' ')}
                <br>
                Recorded at: ${date_bus.toLocaleTimeString()}
            `;

            // Create a custom div icon with the service number
            var customIcon = L.divIcon({
                className: 'custom-icon',
                html: `<div class="bus-icon" style="background-color: ${coordinates[key][i]['directionRef'] === 'INBOUND' ? '#2ecc71' : '#f1c40f'}; ${coordinates[key][i]['directionRef'] === 'OUTBOUND' ? 'border-style: dotted;' : '' } ${TIME_DIFF > 1*60*1000 ? 'text-decoration: underline;' : ''} ${TIME_DIFF > 3*60*1000 ? 'opacity: 0.3;' : ''}">
                        <b>
                            ${coordinates[key][i]['publishedLineName']}
                        </b>
                    </div>`
            });

            var marker = L.marker(
                [coordinates[key][i]['vehicleLocation'].latitude, coordinates[key][i]['vehicleLocation'].longitude],
                {
                    icon: customIcon,
                    tags: [coordinates[key][i]['lineRef']]
                })
                .bindPopup(POPUP_STRING)
                .on('click', function(e) {
                    e.target.openPopup();
                })
                .addTo(map);

            if (!services.includes(coordinates[key][i]['lineRef'])) {
                services.push(coordinates[key][i]['lineRef']); // Add operator to the array
            }
        }
    }
    
    services.sort();
    
    L.control.tagFilterButton({
        data: services,
        icon: '<i class="fa fa-bus"></i>',
        filterOnEveryClick: true
    }).addTo( map );
    </script>
